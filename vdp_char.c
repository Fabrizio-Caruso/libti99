#include "vdp.h"

#ifdef ENABLE_TEXT64
static const unsigned int font3x5[] = {
0x0000,0x0000,0x0000,0x0000,0x0044,0x4444,0x0044,0x0000,0x00AA,0xAA00,0x0000,0x0000,0x00AA,0xEEAA,0xEEAA,0x0000,
0x44EE,0x8844,0x22EE,0x4400,0x0088,0x2244,0x8822,0x0000,0x0044,0xAA44,0xAA55,0x0000,0x0044,0x4400,0x0000,0x0000,
0x0022,0x4444,0x4422,0x0000,0x0088,0x4444,0x4488,0x0000,0x00AA,0x44EE,0x44AA,0x0000,0x0000,0x44EE,0x4400,0x0000,
0x0000,0x0000,0x0044,0x8800,0x0000,0x00EE,0x0000,0x0000,0x0000,0x0000,0x0044,0x0000,0x0022,0x2244,0x8888,0x0000,
0x0044,0xAAAA,0xAA44,0x0000,0x0044,0xCC44,0x44EE,0x0000,0x00CC,0x2244,0x88EE,0x0000,0x00CC,0x2244,0x22CC,0x0000,
0x00AA,0xAAEE,0x2222,0x0000,0x00EE,0x88CC,0x22CC,0x0000,0x0066,0x88CC,0xAA44,0x0000,0x00EE,0x2244,0x8888,0x0000,
0x0044,0xAA44,0xAA44,0x0000,0x0044,0xAA66,0x2244,0x0000,0x0000,0x0044,0x0044,0x0000,0x0000,0x0044,0x0044,0x8800,
0x0022,0x4488,0x4422,0x0000,0x0000,0xEE00,0xEE00,0x0000,0x0088,0x4422,0x4488,0x0000,0x44AA,0x2244,0x0044,0x0000,
0x0044,0xAAEE,0xEE88,0x4400,0x0044,0xAAEE,0xAAAA,0x0000,0x00CC,0xAACC,0xAACC,0x0000,0x0066,0x8888,0x8866,0x0000,
0x00CC,0xAAAA,0xAACC,0x0000,0x00EE,0x88CC,0x88EE,0x0000,0x00EE,0x88CC,0x8888,0x0000,0x0066,0x88AA,0xAA66,0x0000,
0x00AA,0xAAEE,0xAAAA,0x0000,0x00EE,0x4444,0x44EE,0x0000,0x0022,0x2222,0xAAEE,0x0000,0x00AA,0xAACC,0xAAAA,0x0000,
0x0088,0x8888,0x88EE,0x0000,0x00AA,0xEEEE,0xAAAA,0x0000,0x00CC,0xAAAA,0xAAAA,0x0000,0x0066,0xAAAA,0xAACC,0x0000,
0x00CC,0xAACC,0x8888,0x0000,0x0066,0xAAAA,0xAACC,0x2200,0x00CC,0xAACC,0xAAAA,0x0000,0x0066,0x8844,0x22CC,0x0000,
0x00EE,0x4444,0x4444,0x0000,0x00AA,0xAAAA,0xAAEE,0x0000,0x00AA,0xAAAA,0x4444,0x0000,0x00AA,0xAAEE,0xEEAA,0x0000,
0x00AA,0xAA44,0xAAAA,0x0000,0x00AA,0xAA44,0x4444,0x0000,0x00EE,0x2244,0x88EE,0x0000,0x0066,0x4444,0x4466,0x0000,
0x0088,0x8844,0x2222,0x0000,0x00CC,0x4444,0x44CC,0x0000,0x0044,0xAA00,0x0000,0x0000,0x0000,0x0000,0x00EE,0x0000,
0x0088,0x4400,0x0000,0x0000,0x0000,0x66AA,0xAA66,0x0000,0x8888,0xCCAA,0xAACC,0x0000,0x0000,0x6688,0x8866,0x0000,
0x2222,0x66AA,0xAA66,0x0000,0x0000,0x66AA,0xCC66,0x0000,0x6644,0xEE44,0x4444,0x0000,0x0000,0x66AA,0xAA66,0x22CC,
0x8888,0xEEAA,0xAAAA,0x0000,0x4400,0x4444,0x4444,0x0000,0x2200,0x2222,0x22AA,0x4400,0x8888,0xAACC,0xCCAA,0x0000,
0x4444,0x4444,0x4444,0x0000,0x0000,0xEEEE,0xAAAA,0x0000,0x0000,0xCCAA,0xAAAA,0x0000,0x0000,0x44AA,0xAA44,0x0000,
0x0000,0xCCAA,0xAACC,0x8888,0x0000,0x66AA,0xAA66,0x2222,0x0000,0xAACC,0x8888,0x0000,0x0000,0x66CC,0x22CC,0x0000,
0x0044,0xEE44,0x4444,0x0000,0x0000,0xAAAA,0xAAEE,0x0000,0x0000,0xAAAA,0xAA44,0x0000,0x0000,0xAAAA,0xEEEE,0x0000,
0x0000,0xAA44,0x44AA,0x0000,0x0000,0xAAAA,0xAA66,0x22CC,0x0000,0xEE66,0x88EE,0x0000,0x0066,0x4488,0x4466,0x0000,
0x0044,0x4400,0x4444,0x0000,0x00CC,0x4422,0x44CC,0x0000,0x00CC,0x6600,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,
0x6688,0x8888,0x6622,0x6600,0xAA00,0xAAAA,0xAAEE,0x0000,0x2244,0x66AA,0xCC66,0x0000,0x44AA,0x66AA,0xAA55,0x0000,
0xAA00,0x66AA,0xAA55,0x0000,0x8844,0x66AA,0xAA55,0x0000,0x4400,0x66AA,0xAA55,0x0000,0x0000,0x6688,0x8866,0x2266,
0x44AA,0x66AA,0xCC66,0x0000,0xAA00,0x66AA,0xCC66,0x0000,0x8844,0x66AA,0xCC66,0x0000,0xAA44,0x4444,0x44EE,0x0000,
0x44AA,0x4444,0x44EE,0x0000,0x8844,0x4444,0x44EE,0x0000,0xAA44,0xAAEE,0xAAAA,0x0000,0x4444,0xAAEE,0xAAAA,0x0000,
0x44EE,0x88CC,0x88EE,0x0000,0x0000,0x77BB,0xAA77,0x0000,0x0077,0xAAFF,0xAABB,0x0000,0x44AA,0x44AA,0xAA44,0x0000,
0xAA00,0x44AA,0xAA44,0x0000,0x8844,0x44AA,0xAA44,0x0000,0x44AA,0x00AA,0xAAEE,0x0000,0x8844,0x00AA,0xAAEE,0x0000,
0xAA00,0xAAAA,0xAA66,0x22CC,0xAA66,0xAAAA,0xAACC,0x0000,0xAA00,0xAAAA,0xAAEE,0x0000,0x0011,0x66EE,0xAACC,0x0000,
0x6644,0xEE44,0x55EE,0x0000,0x0077,0xAAEE,0xAACC,0x0000,0x0000,0x00AA,0x44AA,0x0000,0x6644,0xEE44,0x4444,0x8800,
0x2244,0x66AA,0xAA55,0x0000,0x2244,0x0044,0x4444,0x0000,0x2244,0x44AA,0xAA44,0x0000,0x2244,0x00AA,0xAAEE,0x0000,
0x66CC,0x00CC,0xAAAA,0x0000,0xEE00,0xCCAA,0xAAAA,0x0000,0x6622,0x6666,0x0000,0x0000,0x44AA,0x4400,0x0000,0x0000,
0x4400,0x4488,0xAA44,0x0000,0x0066,0x99BB,0x6600,0x0000,0x0000,0xEE22,0x0000,0x0000,0x8888,0xAA44,0xBB11,0x2233,
0x8888,0xAA44,0x8855,0x7711,0x0044,0x0044,0x4444,0x0000,0x0000,0x55AA,0x5500,0x0000,0x0000,0xAA55,0xAA00,0x0000,
0xAA00,0x5500,0xAA00,0x5500,0x55AA,0x55AA,0x55AA,0x5500,0xFFAA,0xFF55,0xFFAA,0xFF00,0x4444,0x4444,0x4444,0x4444,
0x4444,0x44CC,0x4444,0x4444,0x2244,0xAAEE,0xAAAA,0x0000,0x44AA,0x44AA,0xEEAA,0x0000,0x8844,0xAAEE,0xAAAA,0x0000,
0x0066,0x99BB,0x9966,0x0000,0xAAAA,0xAA22,0xAAAA,0xAAAA,0xAAAA,0xAAAA,0xAAAA,0xAAAA,0x0000,0xEE22,0xAAAA,0xAAAA,
0xAAAA,0xAA22,0xEE00,0x0000,0x0022,0xEECC,0xEE88,0x0000,0xAAAA,0x44EE,0x44EE,0x4400,0x0000,0x00CC,0x4444,0x4444,
0x4444,0x4477,0x0000,0x0000,0x4444,0x44FF,0x0000,0x0000,0x0000,0x00FF,0x4444,0x4444,0x4444,0x4477,0x4444,0x4444,
0x0000,0x00FF,0x0000,0x0000,0x4444,0x44FF,0x4444,0x4444,0xEE00,0x66AA,0xAA55,0x0000,0xEE44,0xAAEE,0xAAAA,0x0000,
0xAAAA,0xBB88,0xFF00,0x0000,0x0000,0xFF88,0xBBAA,0xAAAA,0xAAAA,0xBB00,0xFF00,0x0000,0x0000,0xFF00,0xBBAA,0xAAAA,
0xAAAA,0xBB88,0xBBAA,0xAAAA,0x0000,0xFF00,0xFF00,0x0000,0xAAAA,0xBB00,0xBBAA,0xAAAA,0x00AA,0xEEAA,0xEEAA,0x0000,
0xEE00,0x44AA,0xAA44,0x0000,0x00CC,0xAAEE,0xAACC,0x0000,0xEEEE,0x88CC,0x88EE,0x0000,0xAAEE,0x88CC,0x88EE,0x0000,
0x44EE,0x88CC,0x88EE,0x0000,0x0000,0x4444,0x4444,0x0000,0x2244,0x0044,0x4444,0x0000,0x44AA,0x0044,0x4444,0x0000,
0xAA00,0x4444,0x4444,0x0000,0x4444,0x44CC,0x0000,0x0000,0x0000,0x0077,0x4444,0x4444,0xEEEE,0xEEEE,0xEEEE,0xEEEE,
0x0000,0x0000,0xEEEE,0xEEEE,0x0044,0x4400,0x4444,0x0000,0x8844,0x0044,0x4444,0x0000,0xEEEE,0xEEEE,0x0000,0x0000,
0x2244,0x66AA,0xAACC,0x0000,0x00CC,0xAACC,0xAAAA,0x6600,0xEE00,0x66AA,0xAACC,0x0000,0x8844,0x66AA,0xAACC,0x0000,
0xEE00,0x44AA,0xAA44,0x0000,0xEE00,0x66AA,0xAACC,0x0000,0x0000,0xAAAA,0xAACC,0x8800,0x0088,0xCCAA,0xAACC,0x8800,
0x0088,0xEEAA,0xAAEE,0x8800,0x2244,0xAAAA,0xAAEE,0x0000,0xEE00,0xAAAA,0xAAEE,0x0000,0x8844,0xAAAA,0xAAEE,0x0000,
0x2244,0xAAAA,0xAA66,0x22CC,0x2244,0xAAAA,0x4444,0x0000,0xEE00,0x0000,0x0000,0x0000,0x2244,0x0000,0x0000,0x0000,
0x00EE,0x00EE,0x00EE,0x0000,0x0044,0xEE44,0x00EE,0x0000,0x0000,0x0000,0x00EE,0x00EE,0xCCCC,0x55EE,0x44DD,0x7711,
0x0077,0xDDDD,0x5555,0x0000,0x6644,0xEEAA,0xEE44,0xCC00,0x0044,0x00EE,0x0044,0x0000,0x0000,0x0000,0x0066,0x2244,
0x44AA,0x4400,0x0000,0x0000,0xAA00,0x0000,0x0000,0x0000,0x0000,0x0044,0x0000,0x0000,0x4444,0x4400,0x0000,0x0000,
0xCCCC,0x44CC,0x0000,0x0000,0xCC44,0x88CC,0x0000,0x0000,0x0000,0xEEEE,0xEE00,0x0000,0x0000,0x0000,0x0000,0x0000,
};


static void char64(int pAddr, int ch)
{
    extern int text64_scroll;
    static unsigned int last_offset = 0xffff;
    static unsigned int buf[4];
    unsigned int mask = pAddr & 1 ? 0xf0f0 : 0x0f0f, mask2 = ~mask;
    const unsigned int *font = font3x5 + (ch-32)*4;
    unsigned offset = (pAddr - gImage) >> 1 ; // byte offset
    offset = (offset & 0xff1f) + ((offset + text64_scroll) & 0x00e0);
    offset = offset * 8 + gPattern;
    if (offset != last_offset) {
        vdpmemread(offset, (unsigned char*) buf, 8);
        last_offset = offset;
    }
    buf[0] = (buf[0] & mask) | (*font++ & mask2);
    buf[1] = (buf[1] & mask) | (*font++ & mask2);
    buf[2] = (buf[2] & mask) | (*font++ & mask2);
    buf[3] = (buf[3] & mask) | (*font++ & mask2);
    vdpmemcpy(offset, (unsigned char*) buf, 8);

    extern unsigned int conio_scrnCol; // conio_bgcolor.c
    vdpmemset(offset - gPattern + gColor, conio_scrnCol, 8);


}

#endif


void vdpchar(int pAddr, int ch) {
#ifdef ENABLE_TEXT64
    if (nTextRow == 64*23) {
        char64(pAddr, ch);
        return;
    }
#endif

	VDP_SET_ADDRESS_WRITE(pAddr);
	VDPWD=ch;
#ifdef ENABLE_F18A
    if (gColor == 0x800) {
	extern unsigned int conio_scrnCol; // conio_bgcolor.c
	VDP_SET_ADDRESS_WRITE(pAddr-gImage+gColor);
	VDPWD=conio_scrnCol;
    }
#endif
}
